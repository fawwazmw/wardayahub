---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/blog/PostCard.astro';
import EmptyState from '../../components/blog/EmptyState.astro';
import ErrorState from '../../components/blog/ErrorState.astro';
import { getCategoryBySlug, getPostsByCategory, getCategories } from '../../lib/blog';
import type { Post, Category } from '../../types';

export async function getStaticPaths() {
  try {
    const categories = await getCategories();
    return categories.map((category) => ({
      params: { slug: category.slug },
    }));
  } catch (error) {
    console.error('Error generating category paths:', error);
    return [];
  }
}

const { slug } = Astro.params;

let category: Category | null = null;
let posts: Post[] = [];
let error: string | null = null;

try {
  category = await getCategoryBySlug(slug!);
  if (!category) {
    error = 'Category not found';
  } else {
    posts = await getPostsByCategory(slug!);
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load category';
  console.error('Error loading category:', e);
}
---

{category ? (
  <BaseLayout
    seo={{
      title: `${category.name} - WardayaHub`,
      description: category.description || `Browse all ${category.name} posts`,
      type: 'website',
    }}
  >
    <div class="category-page">
      <div class="container">
        <div class="category-header">
          <div class="header-badge">
            <svg class="badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 7h10v10"/><path d="M7 17 17 7"/>
            </svg>
            <span>Category</span>
          </div>
          
          <h1 class="category-title">{category.name}</h1>
          
          {category.description && (
            <p class="category-description">{category.description}</p>
          )}
          
          <div class="category-meta">
            <span class="post-count">
              <strong>{posts.length}</strong> {posts.length === 1 ? 'article' : 'articles'}
            </span>
          </div>
        </div>

        {posts.length === 0 ? (
          <EmptyState message={`No posts in ${category.name} yet.`} />
        ) : (
          <div class="posts-grid">
            {posts.map((post) => (
              <PostCard post={post} />
            ))}
          </div>
        )}

        <div class="category-footer">
          <a href="/blog" class="btn btn-outline">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5m7 7l-7-7 7-7"/>
            </svg>
            <span>Browse All Posts</span>
          </a>
        </div>
      </div>
    </div>
  </BaseLayout>
) : (
  <BaseLayout
    seo={{
      title: 'Category Not Found - WardayaHub',
      description: 'The requested category could not be found.',
    }}
  >
    <ErrorState error={error || 'Category not found'} />
  </BaseLayout>
)}

<style>
  .category-page {
    padding: var(--spacing-3xl) 0;
  }

  .category-header {
    text-align: center;
    margin-bottom: var(--spacing-3xl);
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }

  .header-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-lg);
    background: hsl(var(--color-muted));
    border: 1px solid hsl(var(--color-border));
    border-radius: var(--radius-2xl);
    font-size: var(--text-sm);
    font-weight: 500;
    color: hsl(var(--color-foreground));
    margin-bottom: var(--spacing-lg);
  }

  .badge-icon {
    width: 16px;
    height: 16px;
    color: hsl(var(--color-primary));
  }

  .category-title {
    font-size: var(--text-4xl);
    font-weight: 800;
    line-height: 1.1;
    margin: 0 0 var(--spacing-md) 0;
    color: hsl(var(--color-foreground));
  }

  .category-description {
    font-size: var(--text-lg);
    color: hsl(var(--color-muted-foreground));
    line-height: 1.6;
    margin: 0 0 var(--spacing-lg) 0;
  }

  .category-meta {
    display: inline-flex;
    padding: var(--spacing-xs) var(--spacing-md);
    background: hsl(var(--color-card));
    border: 1px solid hsl(var(--color-border));
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: hsl(var(--color-muted-foreground));
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-3xl);
  }

  .category-footer {
    text-align: center;
    padding: var(--spacing-xl) 0;
    border-top: 1px solid hsl(var(--color-border));
  }

  @media (max-width: 768px) {
    .category-page {
      padding: var(--spacing-2xl) 0;
    }

    .category-title {
      font-size: var(--text-3xl);
    }

    .posts-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-lg);
    }
  }
</style>
